//
//  HomeVC.swift
//  Letports
//
//  Created by John Yun on 8/8/24.
//

import UIKit
import Combine
import Kingfisher

class HomeVC: UIViewController {
    
    weak var coordinator: HomeCoordinator?
    let viewModel = HomeViewModel()
    private var cancellables = Set<AnyCancellable>()
    
    let titleLabel: UILabel = {
        let title = UILabel()
        title.text = "Letports"
        title.font = UIFont.systemFont(ofSize: 40, weight: .bold)
        title.textColor = .lpSub
        title.frame = CGRect(x: 0, y: 0, width: 140, height: 22)
        
        return title
    }()
    
    let teamChangeBtn: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("ÌåÄ Î≥ÄÍ≤Ω", for: .normal)
        button.setTitleColor(.lpBlack, for: .normal)
        button.backgroundColor = .none
        button.layer.cornerRadius = 10
        
        button.frame = CGRect(x: 0, y: 0, width: 61, height: 22)
        
        button.titleLabel?.font = UIFont.systemFont(ofSize: 20, weight: .bold)
        
        return button
    }()
    
    lazy var profileContainerView = createBackgroundWhiteBox()
    
    lazy var teamProfileHorizontalSV = createSV(axis: .horizontal,
                                                alignment: .center,
                                                distribution: .fillProportionally,
                                                spacing: 16)
    
    lazy var teamLogo: UIImageView = {
        let imageView = UIImageView()
        imageView.widthAnchor.constraint(equalToConstant: 70).isActive = true
        imageView.heightAnchor.constraint(equalToConstant: 70).isActive = true
        imageView.contentMode = .scaleAspectFill
        imageView.clipsToBounds = true
        return imageView
    }()
    
    // ÌåÄ Ïù¥Î¶Ñ ÏûàÎäî ÏÑ∏Î°ú Ïä§ÌÉùÎ∑∞
    lazy var teamProfileVerticalSV = createSV(axis: .vertical,
                                              alignment: .fill,
                                              distribution: .fillProportionally,
                                              spacing: 16)
    
    lazy var teamName = createLabel(text: "", fontSize: 30, fontWeight: .bold)
    
    // URLÏä§ÌÉùÎ∑∞
    lazy var urlSV = createSV(axis: .horizontal, alignment: .fill, distribution: .fillProportionally, spacing: 4)
    
    // Ìôà ÏïÑÏù¥ÏΩò, Ïù¥Î¶Ñ Ïä§ÌÉùÎ∑∞
    lazy var homeURLSV = createSV(axis: .horizontal, alignment: .fill, distribution: .fillProportionally, spacing: 4)
    let homeIcon = UIImageView(image: UIImage(named: "Home"))
    lazy var homeLabel = createLabel(text: "ÌôàÌéòÏù¥ÏßÄ", fontSize: 12)
    
    // Ïù∏Ïä§ÌÉÄ ÏïÑÏù¥ÏΩò, Ïù¥Î¶Ñ Ïä§ÌÉùÎ∑∞
    lazy var instagramURLSV = createSV(axis: .horizontal,
                                       alignment: .fill,
                                       distribution: .fillProportionally,
                                       spacing: 4)
    
    let instagramIcon = UIImageView(image: UIImage(named: "Instagram"))
    lazy var instagramLabel = createLabel(text: "Í≥µÏãù Ïù∏Ïä§ÌÉÄ", fontSize: 12)
    
    // Ïú†ÌäúÎ∑∞ ÏïÑÏù¥ÏΩò, Ïù¥Î¶Ñ Ïä§ÌÉùÎ∑∞
    lazy var youtubeURLSV = createSV(axis: .horizontal, alignment: .fill, distribution: .fillProportionally, spacing: 4)
    let youtubeIcon = UIImageView(image: UIImage(named: "Youtube"))
    lazy var youtubeLabel = createLabel(text: "Í≥µÏãù Ïú†ÌäúÎ∏å", fontSize: 12)
    
    //"ooÏùò ÏµúÏã† ÏòÅÏÉÅ"ÎùºÎ≤®
    let latestTeamVideoLabel: UILabel = {
        let label = UILabel()
        label.text = ""
        label.font = UIFont.systemFont(ofSize: 20, weight: .bold)
        label.textColor = .lpBlack
        label.sizeToFit()
        label.translatesAutoresizingMaskIntoConstraints = false
        
        return label
    }()
    
    //Ïú†ÌäúÎ∏å Ïç∏ÎÑ§Ïùº Ìù∞ Î∞∞Í≤Ω
    lazy var thumbnailContainerView = createBackgroundWhiteBox()
    
    //Ïç∏ÎÑ§Ïùº Ï†ÑÏ≤¥ Ïä§ÌÉùÎ∑∞
    lazy var thumbnailSV = createSV(axis: .horizontal, alignment: .fill, distribution: .fillEqually, spacing: 20)
    
    //Ïç∏ÎÑ§Ïùº1 Ïä§ÌÉùÎ∑∞
    lazy var firstThumbnailSV = createSV(axis: .vertical, alignment: .fill, distribution: .fillEqually, spacing: 5)
    
    //Ïç∏ÎÑ§Ïùº1 Ïù¥ÎØ∏ÏßÄ
    lazy var firstThumbnail: UIImageView = {
        let image = UIImageView()
        image.contentMode = .scaleAspectFill
        image.layer.cornerRadius = 10
        image.clipsToBounds = true
        image.translatesAutoresizingMaskIntoConstraints = false
        
        return image
    }()
    
    //Ïç∏ÎÑ§Ïùº1 Ï†úÎ™©
    lazy var firstThumbnailTitle: UILabel = {
        let label = UILabel()
        label.text = "Ï†úÎ™©1"
        label.font = UIFont.systemFont(ofSize: 10)
        label.numberOfLines = 2
        label.lineBreakMode = .byTruncatingTail
        label.translatesAutoresizingMaskIntoConstraints = false
        
        return label
    }()
    
    //Ïç∏ÎÑ§Ïùº2 Ïä§ÌÉùÎ∑∞
    lazy var secondThumbnailSV = createSV(axis: .vertical, alignment: .fill, distribution: .fillEqually, spacing: 5)
    
    //Ïç∏ÎÑ§Ïùº2 Ïù¥ÎØ∏ÏßÄ
    lazy var secondThumbnail: UIImageView = {
        let image = UIImageView()
        image.contentMode = .scaleAspectFill
        image.layer.cornerRadius = 10
        image.clipsToBounds = true
        image.translatesAutoresizingMaskIntoConstraints = false
        
        return image
    }()
    
    //Ïç∏ÎÑ§Ïùº2 Ï†úÎ™©
    lazy var secondThumbnailTitle: UILabel = {
        let label = UILabel()
        label.text = "Ï†úÎ™©2"
        label.font = UIFont.systemFont(ofSize: 10)
        label.numberOfLines = 2
        label.lineBreakMode = .byTruncatingTail
        label.translatesAutoresizingMaskIntoConstraints = false
        
        return label
    }()
    
    //Ï∂îÏ≤ú ÏÜåÎ™®ÏûÑ Î∑∞
    let recommendGatheringLabel: UILabel = {
        let label = UILabel()
        label.text = "Ï∂îÏ≤ú ÏÜåÎ™®ÏûÑüî•"
        label.font = UIFont.systemFont(ofSize: 20, weight: .bold)
        label.textColor = .lpBlack
        label.sizeToFit()
        label.translatesAutoresizingMaskIntoConstraints = false
        
        return label
    }()
    
    let gatheringScrollView: UIScrollView = {
        let gatheringScroll = UIScrollView()
        gatheringScroll.translatesAutoresizingMaskIntoConstraints = false
        gatheringScroll.showsHorizontalScrollIndicator = false
        
        return gatheringScroll
    }()
    
    lazy var gatheringSV: UIStackView = {
        let gatheringView = createSV(axis: .horizontal, alignment: .center, distribution: .fill, spacing: 6)
        
        return gatheringView
    }()
    
    //MARK: View Life Cycle
    override func viewDidLoad() {
        super.viewDidLoad()
        
        setupUI()
        bindViewModel()
    }
    
    //MARK: -Methods
    
    // Î∞∞Í≤Ω Ìù∞ Î∞ïÏä§ ÎßåÎì§Í∏∞
    func createBackgroundWhiteBox(backgroundColor: UIColor = .white,
                                  cornerRadius: CGFloat = 15,
                                  shadowColor: UIColor = .black,
                                  shadowOpacity: Float = 0.1,
                                  shadowOffset: CGSize = CGSize(width: 0, height: 2),
                                  shadowRadius: CGFloat = 5) -> UIView {
        let whiteBox = UIView()
        whiteBox.backgroundColor = backgroundColor
        whiteBox.layer.cornerRadius = cornerRadius
        whiteBox.layer.shadowColor = shadowColor.cgColor
        whiteBox.layer.shadowOpacity = shadowOpacity
        whiteBox.layer.shadowOffset = shadowOffset
        whiteBox.layer.shadowRadius = shadowRadius
        whiteBox.translatesAutoresizingMaskIntoConstraints = false
        
        return whiteBox
    }
    
    // Ïä§ÌÉùÎ∑∞ ÎßåÎì§Í∏∞
    func createSV(axis: NSLayoutConstraint.Axis,
                  alignment: UIStackView.Alignment,
                  distribution: UIStackView.Distribution,
                  spacing: CGFloat) -> UIStackView {
        let stackView = UIStackView()
        stackView.axis = axis
        stackView.alignment = alignment
        stackView.distribution = distribution
        stackView.spacing = spacing
        stackView.translatesAutoresizingMaskIntoConstraints = false
        return stackView
    }
    
    // Ïù¥ÎØ∏ÏßÄ Î∑∞ ÎßåÎì§Í∏∞
    func createImageView(systemName: String,
                         tintColor: UIColor? = nil,
                         contentMode: UIView.ContentMode = .scaleAspectFit) -> UIImageView {
        let imageView = UIImageView(image: UIImage(systemName: systemName))
        if let tintColor = tintColor {
            imageView.tintColor = tintColor
        }
        imageView.contentMode = contentMode
        imageView.translatesAutoresizingMaskIntoConstraints = false
        return imageView
    }
    
    // ÎùºÎ≤® ÎßåÎì§Í∏∞
    func createLabel(text: String, fontSize: CGFloat, fontWeight: UIFont.Weight = .regular) -> UILabel {
        let label = UILabel()
        label.text = text
        label.font = UIFont.systemFont(ofSize: fontSize, weight: fontWeight)
        label.translatesAutoresizingMaskIntoConstraints = false
        return label
    }
    
    //UISetting
    func setupUI() {
        view.backgroundColor = .lpBackgroundWhite
        
        self.navigationItem.leftBarButtonItem  = UIBarButtonItem(customView: titleLabel)
        self.navigationItem.rightBarButtonItem = UIBarButtonItem(customView: teamChangeBtn)
        
        profileLayout()
        view.addSubview(latestTeamVideoLabel)
        youtubeThumbnailLayout()
        thumbnailContainerView.addSubview(thumbnailSV)
        view.addSubview(thumbnailContainerView)
        view.addSubview(recommendGatheringLabel)
        view.addSubview(gatheringScrollView)
        gatheringScrollView.addSubview(gatheringSV)
        
        layoutVC()
    }
    
    //ÌîÑÎ°úÌïÑ Î†àÏù¥ÏïÑÏõÉ
    func profileLayout() {
        homeURLSV.addArrangedSubview(homeIcon)
        homeURLSV.addArrangedSubview(homeLabel)
        instagramURLSV.addArrangedSubview(instagramIcon)
        instagramURLSV.addArrangedSubview(instagramLabel)
        youtubeURLSV.addArrangedSubview(youtubeIcon)
        youtubeURLSV.addArrangedSubview(youtubeLabel)
        urlSV.addArrangedSubview(homeURLSV)
        urlSV.addArrangedSubview(instagramURLSV)
        urlSV.addArrangedSubview(youtubeURLSV)
        
        teamProfileVerticalSV.addArrangedSubview(teamName)
        teamProfileVerticalSV.addArrangedSubview(urlSV)
        
        teamProfileHorizontalSV.addArrangedSubview(teamLogo)
        teamProfileHorizontalSV.addArrangedSubview(teamProfileVerticalSV)
        
        profileContainerView.addSubview(teamProfileHorizontalSV)
        view.addSubview(profileContainerView)
        
        lazy var homeTapGesture = UITapGestureRecognizer(target: self, action: #selector(handleHomeTap))
        homeURLSV.addGestureRecognizer(homeTapGesture)
        homeURLSV.isUserInteractionEnabled = true
        
        lazy var instaTapGesture = UITapGestureRecognizer(target: self, action: #selector(handleInstaTap))
        instagramURLSV.addGestureRecognizer(instaTapGesture)
        instagramURLSV.isUserInteractionEnabled = true
        
        lazy var youtubeTapGesture = UITapGestureRecognizer(target: self, action: #selector(handleYoutubeTap))
        youtubeURLSV.addGestureRecognizer(youtubeTapGesture)
        youtubeURLSV.isUserInteractionEnabled = true
    }
    
    //Ïç∏ÎÑ§Ïùº Î†àÏù¥ÏïÑÏõÉ
    func youtubeThumbnailLayout() {
        firstThumbnailSV.addArrangedSubview(firstThumbnail)
        firstThumbnailSV.addArrangedSubview(firstThumbnailTitle)
        secondThumbnailSV.addArrangedSubview(secondThumbnail)
        secondThumbnailSV.addArrangedSubview(secondThumbnailTitle)
        
        //Ï≤´Î≤àÏß∏ Ïç∏ÎÑ§Ïùº ÌÉ≠ Ï†úÏä§Ï≥ê
        let firstThumbnailTapGesture = UITapGestureRecognizer(target: self, action: #selector(handleThumbnail1Tap))
        firstThumbnailSV.addGestureRecognizer(firstThumbnailTapGesture)
        firstThumbnailSV.isUserInteractionEnabled = true
        
        //ÎëêÎ≤àÏß∏ Ïç∏ÎÑ§Ïùº
        let secondThumbnailTapGesture = UITapGestureRecognizer(target: self, action: #selector(handleThumbnail2Tap))
        secondThumbnailSV.addGestureRecognizer(secondThumbnailTapGesture)
        secondThumbnailSV.isUserInteractionEnabled = true
        
        NSLayoutConstraint.activate([
            firstThumbnail.heightAnchor.constraint(equalTo: firstThumbnailSV.heightAnchor, multiplier: 0.75),
            firstThumbnailTitle.heightAnchor.constraint(equalTo: firstThumbnailSV.heightAnchor, multiplier: 0.25),
            secondThumbnail.heightAnchor.constraint(equalTo: secondThumbnailSV.heightAnchor, multiplier: 0.75),
            secondThumbnailTitle.heightAnchor.constraint(equalTo: secondThumbnailSV.heightAnchor, multiplier: 0.25)
        ])
        
        thumbnailSV.addArrangedSubview(firstThumbnailSV)
        thumbnailSV.addArrangedSubview(secondThumbnailSV)
    }
    
    // VCÎ†àÏù¥ÏïÑÏõÉ
    func layoutVC() {
        NSLayoutConstraint.activate([
            profileContainerView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor, constant: 20),
            profileContainerView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            profileContainerView.widthAnchor.constraint(equalToConstant: 361),
            profileContainerView.heightAnchor.constraint(equalToConstant: 110),
            
            teamProfileHorizontalSV.topAnchor.constraint(equalTo: profileContainerView.topAnchor, constant: 10),
            teamProfileHorizontalSV.leftAnchor.constraint(equalTo: profileContainerView.leftAnchor, constant: 10),
            teamProfileHorizontalSV.rightAnchor.constraint(equalTo: profileContainerView.rightAnchor, constant: -10),
            teamProfileHorizontalSV.bottomAnchor.constraint(equalTo: profileContainerView.bottomAnchor, constant: -10),
            
            latestTeamVideoLabel.topAnchor.constraint(equalTo: profileContainerView.bottomAnchor, constant: 20),
            latestTeamVideoLabel.leftAnchor.constraint(equalTo: view.leftAnchor, constant: 15),
            
            thumbnailContainerView.topAnchor.constraint(equalTo: latestTeamVideoLabel.bottomAnchor, constant: 20),
            thumbnailContainerView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            thumbnailContainerView.widthAnchor.constraint(equalToConstant: 361),
            thumbnailContainerView.heightAnchor.constraint(equalToConstant: 120),
            
            thumbnailSV.topAnchor.constraint(equalTo: thumbnailContainerView.topAnchor, constant: 10),
            thumbnailSV.leftAnchor.constraint(equalTo: thumbnailContainerView.leftAnchor, constant: 30),
            thumbnailSV.widthAnchor.constraint(equalToConstant: 300),
            thumbnailSV.heightAnchor.constraint(equalToConstant: 100),
            
            recommendGatheringLabel.topAnchor.constraint(equalTo: thumbnailContainerView.bottomAnchor, constant: 20),
            recommendGatheringLabel.leftAnchor.constraint(equalTo: view.leftAnchor, constant: 15),
            
            gatheringScrollView.topAnchor.constraint(equalTo: recommendGatheringLabel.bottomAnchor, constant: 20),
            gatheringScrollView.leftAnchor.constraint(equalTo: view.leftAnchor, constant: 20),
            gatheringScrollView.widthAnchor.constraint(equalToConstant: 450),
            gatheringScrollView.heightAnchor.constraint(equalToConstant: 200),
            
            gatheringSV.topAnchor.constraint(equalTo: gatheringScrollView.topAnchor),
            gatheringSV.leadingAnchor.constraint(equalTo: gatheringScrollView.leadingAnchor),
            gatheringSV.trailingAnchor.constraint(equalTo: gatheringScrollView.trailingAnchor),
            gatheringSV.bottomAnchor.constraint(equalTo: gatheringScrollView.bottomAnchor),
            gatheringSV.heightAnchor.constraint(equalTo: gatheringScrollView.heightAnchor)
        ])
    }
    
    //Îç∞Ïù¥ÌÑ∞ Î∞îÏù∏Îî©
    private func bindViewModel() {
        viewModel.$team
            .sink { [weak self] team in
                guard let self = self, let team = team else { return }
                if let logoURL = team.teamLogo {
                    self.teamLogo.kf.setImage(with: logoURL)
                } else {
                    self.teamLogo.image = UIImage(named: "home")
                }
                self.teamName.text = team.teamName
                self.latestTeamVideoLabel.text = "\(team.teamName ?? "")Ïùò ÏµúÏã† ÏòÅÏÉÅ"
            }
            .store(in: &cancellables)
        
        viewModel.$latestYoutubeVideos
            .sink { [weak self] videos in
                guard let self = self else { return }
                
                if let video1 = videos.first {
                    self.firstThumbnail.kf.setImage(with: video1.thumbnailURL)
                    self.firstThumbnailTitle.text = video1.title
                    self.firstThumbnail.tag = 0
                }
                
                if videos.count > 1 {
                    let video2 = videos[1]
                    self.secondThumbnail.kf.setImage(with: video2.thumbnailURL)
                    self.secondThumbnailTitle.text = video2.title
                    self.secondThumbnail.tag = 1
                }
            }
            .store(in: &cancellables)
        
        viewModel.$gatherings
            .sink { [weak self] gatherings in
                guard let self = self else { return }
                self.updateGatheringImages(gatherings)
            }
            .store(in: &cancellables)
    }
    
    //Ïç∏ÎÑ§Ïùº Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
    private func updateGatheringImages(_ gatherings: [Gathering]) {
        gatheringSV.arrangedSubviews.forEach { $0.removeFromSuperview() }
        gatherings.forEach { gathering in
            if let url = gathering.gatherImage {
                // Ïª®ÌÖåÏù¥ÎÑà Î∑∞ ÏÉùÏÑ±
                let containerView = UIView()
                containerView.translatesAutoresizingMaskIntoConstraints = false
                containerView.widthAnchor.constraint(equalToConstant: 300).isActive = true
                containerView.heightAnchor.constraint(equalToConstant: 200).isActive = true
                
                // Ïù¥ÎØ∏ÏßÄ Î∑∞ ÏÉùÏÑ± Î∞è Ï∂îÍ∞Ä
                let imageView = UIImageView()
                imageView.contentMode = .scaleAspectFill
                imageView.kf.setImage(with: url)
                imageView.layer.cornerRadius = 10
                imageView.clipsToBounds = true
                imageView.translatesAutoresizingMaskIntoConstraints = false
                containerView.addSubview(imageView)
                
                // Ïù¥Î¶Ñ ÎùºÎ≤® ÏÉùÏÑ± Î∞è Ï∂îÍ∞Ä
                if let gatherName = gathering.gatherName {
                    let nameLabel = UILabel()
                    nameLabel.text = gatherName
                    nameLabel.font = UIFont.systemFont(ofSize: 30, weight: .bold)
                    nameLabel.textColor = .white
                    nameLabel.textAlignment = .center
                    nameLabel.translatesAutoresizingMaskIntoConstraints = false
                    containerView.addSubview(nameLabel)
                    
                    // Ïù¥Î¶Ñ ÎùºÎ≤® Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï
                    NSLayoutConstraint.activate([
                        nameLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 10),
                        nameLabel.bottomAnchor.constraint(equalTo: containerView.bottomAnchor, constant: -5),
                        nameLabel.heightAnchor.constraint(equalToConstant: 40)
                    ])
                }
                
                // Ïù¥ÎØ∏ÏßÄ Î∑∞ Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï
                NSLayoutConstraint.activate([
                    imageView.topAnchor.constraint(equalTo: containerView.topAnchor),
                    imageView.leadingAnchor.constraint(equalTo: containerView.leadingAnchor),
                    imageView.trailingAnchor.constraint(equalTo: containerView.trailingAnchor),
                    imageView.bottomAnchor.constraint(equalTo: containerView.bottomAnchor)
                ])
                
                // Ïª®ÌÖåÏù¥ÎÑà Î∑∞Î•º stackViewÏóê Ï∂îÍ∞Ä
                gatheringSV.addArrangedSubview(containerView)
            }
        }
    }
    
    //url ÌÉ≠ Î∞îÌÖÄÏãúÌä∏
    func presentBottomSheet(with url: URL) {
        let bottomSheetVC = URLVC(url: url)
        bottomSheetVC.modalPresentationStyle = .pageSheet
        
        if let sheet = bottomSheetVC.sheetPresentationController {
            sheet.detents = [.large()]
            sheet.prefersGrabberVisible = true
        }
        present(bottomSheetVC, animated: true, completion: nil)
    }
    
    //Ïú†ÌäúÎ∏å Ïç∏ÎÑ§Ïùº Ïò§Ìîà
    private func openYoutubeVideo(at index: Int) {
        guard index < viewModel.latestYoutubeVideos.count else { return }
        let video = viewModel.latestYoutubeVideos[index]
        presentBottomSheet(with: video.videoURL)
    }
    
    //MARK: -Objc Methods
    //url ÌÉ≠ Ïï°ÏÖò
    @objc func handleHomeTap() {
        if let url = viewModel.team?.homepageURL {
            presentBottomSheet(with: url)
        }
        print("ÌôàÌéòÏù¥ÏßÄ")
    }
    
    @objc func handleInstaTap() {
        if let url = viewModel.team?.instagramURL {
            presentBottomSheet(with: url)
        }
        print("Ïù∏Ïä§ÌÉÄÍ∑∏Îû®")
    }
    
    @objc func handleYoutubeTap() {
        if let url = viewModel.team?.youtubeURL {
            presentBottomSheet(with: url)
        }
        print("Ïú†ÌäúÎ∏å")
    }
    
    //Ïç∏ÎÑ§Ïùº ÌÉ≠ Ïï°ÏÖò
    @objc func handleThumbnail1Tap() {
        openYoutubeVideo(at: 0)
    }
    
    @objc func handleThumbnail2Tap() {
        openYoutubeVideo(at: 1)
    }
}
